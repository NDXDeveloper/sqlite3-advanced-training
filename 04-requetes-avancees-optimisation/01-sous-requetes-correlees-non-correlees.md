üîù Retour au [Sommaire](/SOMMAIRE.md)

# 4.1 Sous-requ√™tes corr√©l√©es et non-corr√©l√©es

## Introduction

Les sous-requ√™tes sont l'un des concepts les plus puissants de SQL. Elles permettent de r√©soudre des probl√®mes complexes en d√©composant une question difficile en plusieurs √©tapes plus simples. Imaginez que vous voulez trouver tous les clients qui ont d√©pens√© plus que la moyenne : vous devez d'abord calculer la moyenne, puis comparer chaque client √† cette moyenne. Les sous-requ√™tes permettent de faire cela en une seule requ√™te !

## Qu'est-ce qu'une sous-requ√™te ?

Une **sous-requ√™te** (ou requ√™te imbriqu√©e) est une requ√™te SQL plac√©e √† l'int√©rieur d'une autre requ√™te SQL. Elle peut appara√Ætre dans les clauses SELECT, WHERE, HAVING, ou FROM.

### Exemple simple pour commencer

```sql
-- Trouver tous les livres plus chers que le prix moyen
SELECT titre, prix
FROM livres
WHERE prix > (SELECT AVG(prix) FROM livres);
```

Dans cet exemple, `(SELECT AVG(prix) FROM livres)` est la sous-requ√™te qui calcule le prix moyen.

## Les deux types de sous-requ√™tes

### 1. Sous-requ√™tes non-corr√©l√©es (ind√©pendantes)

Une sous-requ√™te **non-corr√©l√©e** peut √™tre ex√©cut√©e ind√©pendamment de la requ√™te principale. Elle ne fait pas r√©f√©rence aux colonnes de la requ√™te externe.

#### Caract√©ristiques :
- ‚úÖ Ex√©cut√©e **une seule fois**
- ‚úÖ R√©sultat utilis√© par la requ√™te principale
- ‚úÖ Plus rapide en g√©n√©ral
- ‚úÖ Plus facile √† comprendre et d√©boguer

#### Exemple d√©taill√© :

```sql
-- Cr√©ons d'abord notre base de donn√©es d'exemple
CREATE TABLE livres (
    id INTEGER PRIMARY KEY,
    titre TEXT NOT NULL,
    prix REAL NOT NULL,
    auteur_id INTEGER,
    stock INTEGER
);

CREATE TABLE auteurs (
    id INTEGER PRIMARY KEY,
    nom TEXT NOT NULL,
    pays TEXT
);

-- Ins√©rons quelques donn√©es
INSERT INTO auteurs VALUES
(1, 'Victor Hugo', 'France'),
(2, 'Stephen King', 'USA'),
(3, 'Haruki Murakami', 'Japon');

INSERT INTO livres VALUES
(1, 'Les Mis√©rables', 15.99, 1, 5),
(2, 'Notre-Dame de Paris', 12.50, 1, 3),
(3, '√áa', 18.99, 2, 8),
(4, 'Shining', 16.75, 2, 2),
(5, 'Kafka sur le rivage', 14.99, 3, 6);
```

**Exemple 1 : Livres plus chers que la moyenne**
```sql
SELECT titre, prix
FROM livres
WHERE prix > (
    SELECT AVG(prix)
    FROM livres
);
```
*R√©sultat : √áa (18.99‚Ç¨) et Shining (16.75‚Ç¨)*

**Exemple 2 : Livres des auteurs fran√ßais**
```sql
SELECT titre, prix
FROM livres
WHERE auteur_id IN (
    SELECT id
    FROM auteurs
    WHERE pays = 'France'
);
```
*R√©sultat : Les Mis√©rables et Notre-Dame de Paris*

### 2. Sous-requ√™tes corr√©l√©es (d√©pendantes)

Une sous-requ√™te **corr√©l√©e** fait r√©f√©rence aux colonnes de la requ√™te externe. Elle doit √™tre ex√©cut√©e pour chaque ligne de la requ√™te principale.

#### Caract√©ristiques :
- ‚ö†Ô∏è Ex√©cut√©e **pour chaque ligne** de la requ√™te externe
- ‚ö†Ô∏è Plus lente en g√©n√©ral
- ‚ö†Ô∏è Plus complexe √† comprendre
- ‚úÖ Permet des comparaisons ligne par ligne tr√®s puissantes

#### Exemple d√©taill√© :

```sql
-- Ajoutons une table de commandes pour nos exemples
CREATE TABLE commandes (
    id INTEGER PRIMARY KEY,
    client_id INTEGER,
    livre_id INTEGER,
    quantite INTEGER,
    date_commande DATE
);

INSERT INTO commandes VALUES
(1, 101, 1, 2, '2024-01-15'),
(2, 102, 3, 1, '2024-01-16'),
(3, 101, 5, 3, '2024-01-17'),
(4, 103, 2, 1, '2024-01-18'),
(5, 102, 4, 2, '2024-01-19');
```

**Exemple 1 : Livres qui ont √©t√© command√©s**
```sql
SELECT titre, prix
FROM livres L
WHERE EXISTS (
    SELECT 1
    FROM commandes C
    WHERE C.livre_id = L.id  -- R√©f√©rence √† la table externe !
);
```
*Notice : `L.id` dans la sous-requ√™te fait r√©f√©rence √† la requ√™te externe*

**Exemple 2 : Auteurs avec le livre le plus cher par auteur**
```sql
SELECT nom
FROM auteurs A
WHERE EXISTS (
    SELECT 1
    FROM livres L
    WHERE L.auteur_id = A.id
    AND L.prix = (
        SELECT MAX(prix)
        FROM livres L2
        WHERE L2.auteur_id = A.id
    )
);
```

## Diff√©rences visuelles pour mieux comprendre

### Sous-requ√™te non-corr√©l√©e :
```
1. SQLite ex√©cute la sous-requ√™te ‚Üí R√©sultat : 15.84 (prix moyen)
2. SQLite utilise ce r√©sultat dans la requ√™te principale
3. Une seule ex√©cution de la sous-requ√™te !

SELECT titre FROM livres WHERE prix > (SELECT AVG(prix) FROM livres);
                                      ‚Üë
                                Ex√©cut√©e 1 fois
```

### Sous-requ√™te corr√©l√©e :
```
Pour chaque livre dans la requ√™te principale :
1. Livre "Les Mis√©rables" ‚Üí Ex√©cute la sous-requ√™te pour ce livre
2. Livre "Notre-Dame" ‚Üí Ex√©cute la sous-requ√™te pour ce livre
3. Livre "√áa" ‚Üí Ex√©cute la sous-requ√™te pour ce livre
...

SELECT titre FROM livres L WHERE EXISTS (SELECT 1 FROM commandes WHERE livre_id = L.id);
                                         ‚Üë
                                    Ex√©cut√©e pour chaque ligne !
```

## Op√©rateurs couramment utilis√©s avec les sous-requ√™tes

### 1. **IN / NOT IN**
```sql
-- Livres des auteurs am√©ricains
SELECT titre
FROM livres
WHERE auteur_id IN (
    SELECT id FROM auteurs WHERE pays = 'USA'
);

-- Livres qui ne sont PAS des auteurs fran√ßais
SELECT titre
FROM livres
WHERE auteur_id NOT IN (
    SELECT id FROM auteurs WHERE pays = 'France'
);
```

### 2. **EXISTS / NOT EXISTS**
```sql
-- Auteurs qui ont publi√© des livres
SELECT nom
FROM auteurs A
WHERE EXISTS (
    SELECT 1 FROM livres L WHERE L.auteur_id = A.id
);

-- Livres jamais command√©s
SELECT titre
FROM livres L
WHERE NOT EXISTS (
    SELECT 1 FROM commandes C WHERE C.livre_id = L.id
);
```

### 3. **Comparateurs avec sous-requ√™tes**
```sql
-- Livre le plus cher
SELECT titre, prix
FROM livres
WHERE prix = (SELECT MAX(prix) FROM livres);

-- Livres plus chers que tous les livres de Victor Hugo
SELECT titre, prix
FROM livres
WHERE prix > ALL (
    SELECT prix FROM livres L
    JOIN auteurs A ON L.auteur_id = A.id
    WHERE A.nom = 'Victor Hugo'
);

-- Livres plus chers qu'au moins un livre de Stephen King
SELECT titre, prix
FROM livres
WHERE prix > ANY (
    SELECT prix FROM livres L
    JOIN auteurs A ON L.auteur_id = A.id
    WHERE A.nom = 'Stephen King'
);
```

## Sous-requ√™tes dans diff√©rentes clauses

### Dans la clause SELECT
```sql
-- Afficher le prix et la diff√©rence avec le prix moyen
SELECT
    titre,
    prix,
    prix - (SELECT AVG(prix) FROM livres) AS difference_moyenne
FROM livres;
```

### Dans la clause FROM
```sql
-- Sous-requ√™te utilis√©e comme table temporaire
SELECT
    pays,
    AVG(prix_moyen_auteur) as prix_moyen_pays
FROM (
    SELECT
        A.pays,
        A.nom,
        AVG(L.prix) as prix_moyen_auteur
    FROM auteurs A
    JOIN livres L ON A.id = L.auteur_id
    GROUP BY A.id, A.nom, A.pays
) AS stats_auteurs
GROUP BY pays;
```

### Dans la clause HAVING
```sql
-- Auteurs dont le prix moyen est sup√©rieur au prix moyen global
SELECT
    A.nom,
    AVG(L.prix) as prix_moyen
FROM auteurs A
JOIN livres L ON A.id = L.auteur_id
GROUP BY A.id, A.nom
HAVING AVG(L.prix) > (
    SELECT AVG(prix) FROM livres
);
```

## Exemples pratiques du monde r√©el

### Exemple 1 : Analyse des ventes
```sql
-- Clients qui ont d√©pens√© plus que la moyenne
SELECT
    client_id,
    SUM(L.prix * C.quantite) as total_depense
FROM commandes C
JOIN livres L ON C.livre_id = L.id
GROUP BY client_id
HAVING SUM(L.prix * C.quantite) > (
    SELECT AVG(total_par_client)
    FROM (
        SELECT SUM(L2.prix * C2.quantite) as total_par_client
        FROM commandes C2
        JOIN livres L2 ON C2.livre_id = L2.id
        GROUP BY client_id
    )
);
```

### Exemple 2 : Gestion des stocks
```sql
-- Livres avec un stock inf√©rieur √† la moyenne ET qui ont des commandes
SELECT titre, stock
FROM livres L
WHERE stock < (SELECT AVG(stock) FROM livres)
AND EXISTS (
    SELECT 1 FROM commandes C WHERE C.livre_id = L.id
);
```

## Pi√®ges √† √©viter

### 1. **Attention avec NULL et NOT IN**
```sql
-- ‚ùå PROBL√àME : Si un auteur a un pays NULL, cette requ√™te ne retournera RIEN
SELECT titre
FROM livres
WHERE auteur_id NOT IN (
    SELECT id FROM auteurs WHERE pays = 'France'  -- Si un id est NULL...
);

-- ‚úÖ SOLUTION : G√©rer les NULL explicitement
SELECT titre
FROM livres
WHERE auteur_id NOT IN (
    SELECT id FROM auteurs WHERE pays = 'France' AND id IS NOT NULL
);
```

### 2. **Performance des sous-requ√™tes corr√©l√©es**
```sql
-- ‚ùå LENT : Sous-requ√™te corr√©l√©e qui peut √™tre √©vit√©e
SELECT titre
FROM livres L
WHERE EXISTS (
    SELECT 1 FROM auteurs A WHERE A.id = L.auteur_id AND A.pays = 'France'
);

-- ‚úÖ PLUS RAPIDE : Utiliser une jointure
SELECT L.titre
FROM livres L
JOIN auteurs A ON L.auteur_id = A.id
WHERE A.pays = 'France';
```

## Quand utiliser chaque type ?

### Utilisez les sous-requ√™tes non-corr√©l√©es quand :
- Vous avez besoin d'une valeur calcul√©e (moyenne, maximum, etc.)
- La sous-requ√™te peut √™tre ex√©cut√©e ind√©pendamment
- Vous voulez filtrer sur une liste de valeurs

### Utilisez les sous-requ√™tes corr√©l√©es quand :
- Vous avez besoin de comparaisons ligne par ligne
- Vous voulez tester l'existence d'enregistrements li√©s
- Les jointures ne permettent pas d'exprimer facilement votre logique

## Exercices pratiques

### Exercice 1 (D√©butant)
Trouvez tous les livres dont le prix est sup√©rieur au prix du livre le plus cher de Victor Hugo.

<details>
<summary>Solution</summary>

```sql
SELECT titre, prix
FROM livres
WHERE prix > (
    SELECT MAX(L.prix)
    FROM livres L
    JOIN auteurs A ON L.auteur_id = A.id
    WHERE A.nom = 'Victor Hugo'
);
```
</details>

### Exercice 2 (Interm√©diaire)
Trouvez les auteurs qui ont √©crit au moins un livre plus cher que 15‚Ç¨.

<details>
<summary>Solution</summary>

```sql
SELECT DISTINCT nom
FROM auteurs A
WHERE EXISTS (
    SELECT 1
    FROM livres L
    WHERE L.auteur_id = A.id
    AND L.prix > 15
);
```
</details>

### Exercice 3 (Avanc√©)
Pour chaque auteur, affichez son nom et le nombre de ses livres qui sont plus chers que le prix moyen de TOUS les livres.

<details>
<summary>Solution</summary>

```sql
SELECT
    A.nom,
    (SELECT COUNT(*)
     FROM livres L
     WHERE L.auteur_id = A.id
     AND L.prix > (SELECT AVG(prix) FROM livres)
    ) as livres_chers
FROM auteurs A;
```
</details>

## R√©sum√©

Les sous-requ√™tes sont un outil puissant qui vous permet de :
- üéØ **D√©composer** des probl√®mes complexes en √©tapes simples
- üîç **Filtrer** des donn√©es avec des crit√®res sophistiqu√©s
- üìä **Calculer** des statistiques et les utiliser dans vos requ√™tes
- üîó **Comparer** des donn√©es ligne par ligne

**Points cl√©s √† retenir :**
- Les sous-requ√™tes non-corr√©l√©es sont plus rapides mais moins flexibles
- Les sous-requ√™tes corr√©l√©es sont plus puissantes mais plus co√ªteuses
- Attention aux valeurs NULL avec NOT IN
- Parfois une jointure est plus efficace qu'une sous-requ√™te corr√©l√©e

Dans la prochaine section, nous d√©couvrirons les **Expressions de Table Communes (CTE)**, qui offrent une alternative plus lisible et parfois plus performante aux sous-requ√™tes complexes !


‚è≠Ô∏è
